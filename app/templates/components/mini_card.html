{%- from "components/rates.html" import details with context -%}
{%- macro create_card(card, is_postcode=False) -%}
	{%- set main = card.metric | get_data(data) -%}
	{%- set improving = is_improving(card.metric, ((card.metric + "Change") | get_data(data)).raw) -%}
	{%- if improving == True %}
		{% set image = "images/arrow-up-green.png" %}
		{% set colour = 'good' %}
	{%- elif improving == None %}
		{% set image = "images/arrow-up-grey.png" %}
		{% set colour = 'neutral' %}
	{%- elif improving == False %}
		{% set image = "images/arrow-up-red.png" %}
		{% set colour = 'bad' %}
	{%- endif -%}

	<div class="mini-card" itemtype="https://schema.org/WebContent" itemprop="WebContent" itemscope>
		<div>
			<span itemprop="contentLocation" itemtype="http://schema.org/AdministrativeArea" itemscope>
				<meta itemprop="name" content="{{ main.areaName | trim_area_name }}"/>
				<meta itemprop="sameAs" content="https://en.wikipedia.org/wiki/{{ main.areaName }}" />
			</span>
			<meta itemprop="datePosted" content="{{ despatch }}"/>
			<meta itemprop="expires" content="{{ despatch | add_days(1) }}"/>
			<span class="govuk-caption-m govuk-!-font-weight-regular" itemprop="name">{{ card.caption }}</span>
			{%- if is_postcode -%}
				<h4 class="govuk-heading-m title-mobile govuk-!-margin-bottom-0">
					{{ card.heading }} in {{ main.areaName | trim_area_name }}
				</h4>
			{%- else -%}
				<h2 class="govuk-heading-m title-mobile govuk-!-margin-bottom-0">
					{{ card.heading }}
				</h2>
			{%- endif -%}
		</div>
		<p class="grey govuk-!-font-size-14 govuk-!-margin-bottom-0 govuk-!-margin-top-0">
			Latest data {% if is_postcode -%}at <strong>{{ main.areaType | to_full_area_type | lower }}</strong> level{%- endif %}
			provided on&nbsp;<span style="white-space: nowrap">{{ main.date }}</span>
		</p>

		<div class="govuk-grid-row bottom-aligned">
			<div class="govuk-grid-column-full">
				<div class="data-metric2" itemprop="Observation" itemtype="https://schema.org/Observation" itemscope>
					<meta itemprop="name" content="{{ card.heading }} - daily"/>
					<meta itemprop="observationDate" content="{{ main.rawDate }}"/>
					<span itemprop="measuredValue">
						<span itemtype="https://schema.org/Number" itemprop="Number">
							<meta itemprop="QuantitativeValue" content="{{ main.raw }}" itemtype="https://schema.org/QuantitativeValue"/>
						</span>
					</span>

					<div class="govuk-body-s float govuk-!-margin-bottom-0" style="width:80%;">Daily</div>
					<div class="number-group">
						<div class="number-container">
							<div class="float tooltip">
								<div class="float govuk-heading-m govuk-!-margin-bottom-0 govuk-!-padding-top-0 total-figure2">
									<span class="govuk-link--no-visited-state number-link number">
										{{ main.value }}
										<span class="tooltiptext govuk-!-font-size-16" itemprop="disambiguatingDescription">
											Daily number of {{ card.heading | lower }} reported on {{ main.date }}
										</span>
									</span>
								</div>
							</div>
						</div>
					</div>
				</div>

				{%- set rollingSum = (card.metric + "RollingSum") | get_data(data) -%}
				<div class="data-metric2" itemprop="Observation" itemtype="https://schema.org/Observation" itemscope>
					<meta itemprop="name" content="{{ card.heading }} - sum of the last 7 days"/>
					<span itemprop="observationDate">
						<meta itemtype="https://schema.org/DateTime" itemprop="startDate" content="{{ rollingSum.rawDate | subtract_days(7) }}"/>
						<meta itemtype="https://schema.org/DateTime" itemprop="endDate" content="{{ rollingSum.rawDate }}"/>
					</span>
					<span itemprop="measuredValue">
						<span itemtype="https://schema.org/Number" itemprop="Number">
							<meta itemprop="QuantitativeValue" content="{{ rollingSum.raw }}" itemtype="https://schema.org/QuantitativeValue"/>
						</span>
					</span>

					<div class="govuk-body-s float govuk-!-margin-top-2 govuk-!-margin-bottom-0" style="width:80%;">
						Last 7 days
					</div>
					<div class="number-group">
						<div class="number-container govuk-!-padding-right-4">
							<div class="float tooltip">
								<div class="float govuk-heading-m govuk-!-margin-bottom-0 govuk-!-padding-top-0 total-figure2">
									<span href="#" class="govuk-link--no-visited-state number-link">
										{{ rollingSum.value }}
										<span class="tooltiptext govuk-!-font-size-16" itemprop="disambiguatingDescription">
											Total number of {{ card.heading | lower }} reported in the last 7 days
											({{ rollingSum.rawDate | subtract_days(6) | format_date }} &ndash; {{ rollingSum.date }})
										</span>
									</span>
								</div>
							</div>
						</div>
					</div>

					{%- set change = ((card.metric + "Change") | get_data(data)) -%}
					{%- set changePercentage = ((card.metric + "ChangePercentage") | get_data(data)) -%}
					<div class="number-container" itemprop="Observation" itemtype="https://schema.org/Observation" itemscope>
						<meta itemprop="name" content="{{ card.heading }} - change in the last 7 days"/>
						<span itemprop="observationDate">
							<meta itemtype="https://schema.org/DateTime" itemprop="startDate" content="{{ change.rawDate | subtract_days(14) }}"/>
							<meta itemtype="https://schema.org/DateTime" itemprop="endDate" content="{{ change.rawDate }}"/>
						</span>
						<span itemprop="measuredValue">
							<span itemtype="https://schema.org/Number" itemprop="Number">
								<meta itemprop="QuantitativeValue" content="{{ change.raw }}" itemtype="https://schema.org/QuantitativeValue"/>
							</span>
						</span>

						<div class="float tooltip">
							<div class="float govuk-heading-m govuk-!-margin-bottom-0 govuk-!-padding-top-0 total-figure2">
								<span class="govuk-link--no-visited-state number-link-red" style="border: none">
									<strong class="govuk-tag govuk-tag--red number govuk-!-margin-top-1 change-box {{ colour }}">
										{%- if changePercentage.value != 0 -%}
											<img src="{{ url_for("static", path=image) }}"
											     width="12px"
											     alt="arrow"
											     style="transform: rotate({{ ((card.metric + "Direction")| get_data(data)).raw }}deg)">
											{{ change.value }}
											<span class="govuk-!-font-weight-regular">({{ changePercentage.value }}%)</span>
										{%- else -%}
											<span>No change</span>
										{%- endif -%}
									</strong>
									<span class="tooltiptext govuk-!-font-size-16" itemprop="disambiguatingDescription">
										Change from previous 7 days
										({{ change.rawDate | subtract_days(13) | format_date }} &ndash; {{ change.rawDate | subtract_days(7) | format_date }})
									</span>
								</span>
							</div>
						</div>
					</div>

				</div>
			</div>
		</div>

		{%- if card.caption.lower() == "cases" -%}
			{{ details(card.rate | get_data(data), "by date of specimen as of") }}
		{%- elif card.caption.lower() == "deaths" and not is_postcode -%}
			{{ details(card.rate | get_data(data), "by date of death as of") }}
		{% else %}
			<hr class="govuk-section-break bottom-aligned"/>
		{%- endif -%}
		{%- if not is_postcode -%}
			<a href="/details/{{ card.caption | lower }}"
           itemprop="thumbnailUrl"
				   class="govuk-link govuk-link--no-visited-state bottom-aligned"
				   style="text-decoration: none;">
				<figure class="graph mini-card-figure">
					<img itemprop="image" src="https://{{ base }}/downloads/homepage/{{ date }}/thumbnail_{{ card.metric }}.svg" alt="Graph - click for more details">
				</figure>
			</a>
		{% endif %}
		<hr class="govuk-section-break govuk-section-break--visible bottom-aligned" style="margin: 0 -20px;"/>
		<div class="additional-info bottom-aligned" style="margin-top: 5px">
				<p class="govuk-!-margin-bottom-0 govuk-!-margin-top-0 govuk-!-font-size-16">
				<a href="/details/{{ card.caption | lower }}{%- if is_postcode -%}?areaType={{ main.areaType | lower }}&areaName={{ main.areaName }}{% endif %}"
				   class="govuk-link govuk-link--no-visited-state"
				   style="text-decoration: none"><b>All {{ card.caption | lower }} data{%- if is_postcode %}&nbsp;in {{ main.areaName }}{% endif %}</b></a>
				</p>
		</div>
	</div>
{%- endmacro -%}
